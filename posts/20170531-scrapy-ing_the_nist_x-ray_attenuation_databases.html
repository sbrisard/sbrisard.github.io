<!DOCTYPE html>
<html lang="en">
  <head>
      <title>Sébastien Brisard's blog - Scrapy-ing the NIST X-ray Attenuation Databases</title>
    <link rel="stylesheet" href="https://sbrisard.github.io/theme/css/main.css" />
    <meta charset="utf-8" />
    <link href="https://sbrisard.github.io/feed.xml" type="application/rss+xml" rel="alternate" title="Sébastien Brisard's blog Full RSS Feed" />





  </head>

  <body id="index" class="home">
    <header id="siteheader">
      <img id="sitebanner" src="https://sbrisard.github.io/theme/images/banner.jpg"/>
      <div id="sitename"><a href="https://sbrisard.github.io/">Sébastien Brisard's blog <strong></strong></a></div>
      <nav id="sitemenu">
	<ul>
          <li><a href="/pages/about.html" title="About this blog">About this blog</a></li>
          <li><a href="https://cv.archives-ouvertes.fr/sbrisard" title="About me">About me</a></li>
          <li><a href="/archives.html" title="Archives">Archives</a></li>
          <li><a href="https://github.com/sbrisard" title="GitHub">GitHub</a></li>
          <li><a href="https://twitter.com/SebBrisard" title="Twitter">Twitter</a></li>
          <li><a href="feed.xml" title="RSS">RSS</a></li>
	</ul>
      </nav>
    </header>
<section id="content" class="body">
  <header>
    <h1 class="entry-title">
      <a href="https://sbrisard.github.io/posts/20170531-scrapy-ing_the_nist_x-ray_attenuation_databases.html" rel="bookmark"
         title="Permalink to Scrapy-ing the NIST X-ray Attenuation Databases">Scrapy-ing the NIST X-ray Attenuation Databases</a></h1>
 
  </header>
  <footer class="post-info">
    <time class="published" datetime="2017-05-31T00:00:00+02:00">
      Published 31 May 2017
    </time>
    <address class="vcard author">
      by           <a class="url fn" href="https://sbrisard.github.io/author/sebastien-brisard.html">Sébastien Brisard</a>
    </address>
    <div class="category">
        Category: <a href="https://sbrisard.github.io/category/posts.html">posts</a>
    </div>
  </footer><!-- /.post-info -->
  <div class="entry-content">
    <p>I am currently preparing with two other colleagues a review paper on X-ray
tomography of cementitious materials, for which I need to retrieve tabulated
values of the <a href="https://en.wikipedia.org/wiki/Mass_attenuation_coefficient#Mass_attenuation_coefficients_for_X-rays">X-ray mass attenuation
coefficients</a>
of all elements. NIST provides such data (see <a href="https://www.nist.gov/pml/x-ray-mass-attenuation-coefficients">X-Ray Mass Attenuation
Coefficients</a> by
J. H. Hubbell and S. M. Seltzer). However, it does not come in the form of
simple files that can be downloaded. Rather, the values are presented in nicely
formatted HTML tables (see
<a href="http://physics.nist.gov/PhysRefData/XrayMassCoef/ElemTab/z01.html">here</a> for an
example).</p>
<p>In this post, I set out to extract this data as a HDF5 table. Of course, this
looks like a job for <a href="https://scrapy.org/">Scrapy</a>!</p>
<h2>First steps with Scrapy</h2>
<p>I am brand new to Scrapy, but found the excellent
<a href="https://docs.scrapy.org/en/latest/">tutorial</a> extremely useful. If you use
Miniconda from <a href="https://www.continuum.io/">Continuum Analytics</a>, then
installation of Scrapy is a very smooth procedure</p>
<div class="highlight"><pre><span></span><code>conda create --name scrapy python=3 scrapy
activate scrapy
</code></pre></div>

<p>which installs Scrapy in a new environment (called <code>scrapy</code>).</p>
<h2>Downloading the table for one single element</h2>
<p>In this section, we retrieve the data for the mass attenuation coefficient of
one single element. We start with the data for hydrogen, which can be found
<a href="http://physics.nist.gov/PhysRefData/XrayMassCoef/ElemTab/z01.html">here</a>.
Following the <a href="https://docs.scrapy.org/en/latest/intro/tutorial.html#extracting-data">Scrapy
tutorial</a>,
we first use the Scrapy shell.</p>
<div class="highlight"><pre><span></span><code>scrapy shell &quot;http://physics.nist.gov/PhysRefData/XrayMassCoef/ElemTab/z01.html&quot;
</code></pre></div>

<p>Looking at the page source, it is observed that the table in ASCII format is
located within a <code>pre</code> tag. This suggests the following CSS selector</p>
<div class="highlight"><pre><span></span><code><span class="n">out</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">css</span><span class="p">(</span><span class="s1">&#39;pre&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">extract_first</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</code></pre></div>

<p>which produces the following abbreviated output</p>
<div class="highlight"><pre><span></span><code>&lt;pre&gt;__________________________________

   &lt;b&gt;Energy&lt;/b&gt;&lt;sub&gt; &lt;/sub&gt;       &lt;i&gt;µ&lt;/i&gt;/&lt;i&gt;?&lt;/i&gt;        &lt;i&gt;µ&lt;/i&gt;&lt;sub&gt;en&lt;/sub&gt;/&lt;i&gt;?&lt;/i&gt;
   &lt;sup&gt; &lt;/sup&gt;(MeV)      (cm&lt;sup&gt;2&lt;/sup&gt;/g)     (cm&lt;sup&gt;2&lt;/sup&gt;/g)
__________________________________

 1.00000E-03  7.217E+00  6.820E+00
 1.50000E-03  2.148E+00  1.752E+00
 .................................
 1.50000E+01  2.539E-02  1.837E-02
 2.00000E+01  2.153E-02  1.606E-02
&lt;/pre&gt;
</code></pre></div>

<p>This is already quite good. We now break the above output in lines, eliminate
the first six lines which correspond to the header, and convert each row to
floats.</p>
<div class="highlight"><pre><span></span><code><span class="n">lines</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
<span class="n">table</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>[[0.001, 7.217, 6.82], [0.0015, 2.148, 1.752],
..................................................,
[15.0, 0.02539, 0.01837], [20.0, 0.02153, 0.01606]]
</code></pre></div>

<p>… and we're done! Or?!? Let's see what happens with
<a href="http://physics.nist.gov/PhysRefData/XrayMassCoef/ElemTab/z13.html">aluminum</a>.</p>
<div class="highlight"><pre><span></span><code>activate scrapy
scrapy shell &quot;http://physics.nist.gov/PhysRefData/XrayMassCoef/ElemTab/z13.html&quot;
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">out</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">css</span><span class="p">(</span><span class="s1">&#39;pre&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">extract_first</span><span class="p">()</span>
<span class="n">lines</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
<span class="n">table</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
</code></pre></div>

<p>This produces the following error</p>
<div class="highlight"><pre><span></span><code>Traceback (most recent call last):
  File &quot;&lt;console&gt;&quot;, line 1, in &lt;module&gt;
  File &quot;&lt;console&gt;&quot;, line 1, in &lt;listcomp&gt;
  File &quot;&lt;console&gt;&quot;, line 1, in &lt;listcomp&gt;
ValueError: could not convert string to float: &#39;K&#39;
</code></pre></div>

<p>which has to do with the <a href="https://en.wikipedia.org/wiki/Absorption_edge">absorption
edge</a> of the element. It is
marked by a letter in the first column of the table</p>
<div class="highlight"><pre><span></span><code><span class="n">lines</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>&#39;K  1.55960E-03  3.957E+03  3.829E+03 &#39;
</code></pre></div>

<p>So, we need to check wether each element of the current row is indeed a float
(see function <code>is_float</code> below).</p>
<h2>Downloading tables for all elements</h2>
<p>All links follow the same pattern
<code>http://physics.nist.gov/PhysRefData/XrayMassCoef/ElemTab/zZZ.html</code>, where ZZ is
the <a href="https://en.wikipedia.org/wiki/Atomic_number">atomic number</a>. So we only
need to generate a list of links in the <code>Spider</code>.</p>
<p>We start by creating a Scrapy project.</p>
<div class="highlight"><pre><span></span><code>scrapy startproject scrapymu
</code></pre></div>

<p>We then edit the <code>scrapymu/scrapymu/spiders/table3.py</code> file</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">scrapy</span>

<span class="n">BASE_URL</span> <span class="o">=</span> <span class="s1">&#39;http://physics.nist.gov/PhysRefData/XrayMassCoef&#39;</span>
<span class="n">TABLE3_URL</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">BASE_URL</span><span class="p">,</span> <span class="s1">&#39;ElemTab/z</span><span class="si">{:02d}</span><span class="s1">.html&#39;</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">is_float</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>


<span class="k">class</span> <span class="nc">Table3Spider</span><span class="p">(</span><span class="n">scrapy</span><span class="o">.</span><span class="n">Spider</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;table3&#39;</span>

    <span class="n">start_urls</span> <span class="o">=</span> <span class="p">[</span><span class="n">TABLE3_URL</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">93</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="c1"># Retrieving the atomic number from the URL</span>
        <span class="n">z</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">url</span><span class="p">[</span><span class="o">-</span><span class="mi">7</span><span class="p">:</span><span class="o">-</span><span class="mi">5</span><span class="p">])</span>

        <span class="n">pre</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">css</span><span class="p">(</span><span class="s1">&#39;pre&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">extract_first</span><span class="p">()</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">pre</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="n">all_rows</span> <span class="o">=</span> <span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">if</span> <span class="n">is_float</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">all_rows</span> <span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">r</span> <span class="o">!=</span> <span class="p">[]]</span>
        <span class="k">yield</span> <span class="p">{</span><span class="n">z</span><span class="p">:</span> <span class="n">rows</span><span class="p">}</span>
</code></pre></div>

<p>It returns a <code>dict</code> of <code>dict</code>, each of which maps the element's atomic number Z
to the corresponding table (as a list of rows, each row being itself a list). It
can be run as follows</p>
<div class="highlight"><pre><span></span><code>scrapy crawl table3 -o table3.json
</code></pre></div>

<h2>Retrieving the material constants of all elements</h2>
<p>We will also need the data from <a href="http://physics.nist.gov/PhysRefData/XrayMassCoef/tab1.html">Table
1</a>. The spider is
quite simple.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">scrapy</span>

<span class="n">BASE_URL</span> <span class="o">=</span> <span class="s1">&#39;http://physics.nist.gov/PhysRefData/XrayMassCoef&#39;</span>
<span class="n">TABLE1_URL</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">BASE_URL</span><span class="p">,</span> <span class="s1">&#39;tab1.html&#39;</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">parse_table1_row</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="n">all_cols</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">css</span><span class="p">(</span><span class="s1">&#39;td::text&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">extract</span><span class="p">())</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">all_cols</span> <span class="k">if</span> <span class="n">c</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">cols</span> <span class="o">!=</span> <span class="p">[]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">z</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cols</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">cols</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">cols</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                    <span class="s1">&#39;Z/A&#39;</span><span class="p">:</span> <span class="n">cols</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                    <span class="s1">&#39;density [g/cm^3]&#39;</span><span class="p">:</span> <span class="n">cols</span><span class="p">[</span><span class="mi">5</span><span class="p">]}</span>
            <span class="k">return</span> <span class="n">z</span><span class="p">,</span> <span class="n">data</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>


<span class="k">class</span> <span class="nc">Table1Spider</span><span class="p">(</span><span class="n">scrapy</span><span class="o">.</span><span class="n">Spider</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;table1&#39;</span>

    <span class="n">start_urls</span> <span class="o">=</span> <span class="p">[</span><span class="n">TABLE1_URL</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="n">all_rows</span> <span class="o">=</span> <span class="p">(</span><span class="n">parse_table1_row</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">css</span><span class="p">(</span><span class="s1">&#39;tr&#39;</span><span class="p">))</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">all_rows</span> <span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">yield</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">}</span>
</code></pre></div>

<p>It returns a <code>dict</code> which maps the element's atomic number Z to a <code>dict</code>
containing the element's <code>symbol</code>, <code>name</code>, <code>Z/A</code> ratio and <code>density</code>.</p>
<h2>Putting it all together in a HDF5 file</h2>
<p>We are now ready to run our two spiders</p>
<div class="highlight"><pre><span></span><code>scrapy crawl table1 -o table1.json
scrapy crawl table3 -o table3.json
</code></pre></div>

<p>You can download the json files here: <a href="https://sbrisard.github.io/posts/20170531-Scrapy-ing_the_NIST_X-ray_Attenuation_Databases/table1.json">Table
1</a>
and <a href="https://sbrisard.github.io/posts/20170531-Scrapy-ing_the_NIST_X-ray_Attenuation_Databases/table3.json">Table
3</a>.
We use the <code>json</code> module in the standard library to read this files, and merge
the <code>dict</code> of <code>dicts</code> that corresponds to Table 3 into one single <code>dict</code>.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">json</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;table1.json&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">table1</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;table3.json&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">table3</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="n">table1</span><span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">table3</span><span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">])</span>
</code></pre></div>

<p>We are now ready to create our HDF5 file. Its structure is very simple: we
create one dataset per element. The dataset's label is the element's symbol. The
table attached to the dataset is the linear absorption coefficient. A few
attributes are further attached to the dataset</p>
<ul>
<li><code>name</code>: the element's name,</li>
<li><code>Z</code>: the element's atomic number (byte),</li>
<li><code>Z/A</code>, <code>density [g/cm³]</code>: double precision floats.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">h5py</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;X-ray_mass_absorption_coefficients.hdf5&#39;</span>

<span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">ROOT</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">z</span><span class="p">,</span> <span class="n">attrs</span> <span class="ow">in</span> <span class="n">table1</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="p">[[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">row</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">table3</span><span class="p">[</span><span class="n">z</span><span class="p">]]</span>
        <span class="n">dset</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">],</span>
                                <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mu</span><span class="p">))</span>
        <span class="n">dset</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="n">dset</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Z/A&#39;</span><span class="p">,</span> <span class="s1">&#39;density [g/cm^3]&#39;</span><span class="p">]:</span>
            <span class="n">dset</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
</code></pre></div>

<h2>X-ray mass attenuation coefficients of concrete</h2>
<p>In order to check that everything went fine, we will use the above table to
compute the X-ray mass attenuation coefficients of a typical concrete and
compare the results to that of <a href="http://physics.nist.gov/PhysRefData/XrayMassCoef/ComTab/concrete.html">Table
4</a>.  The
composition of the concrete under consideration is given in <a href="http://physics.nist.gov/PhysRefData/XrayMassCoef/tab2.html">Table
2</a>. It is reproduced
below</p>
<table>
<thead>
<tr>
<th align="center">Symbol</th>
<th align="center">Z</th>
<th align="center">Mass fraction</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">H</td>
<td align="center">1</td>
<td align="center">0.022100</td>
</tr>
<tr>
<td align="center">C</td>
<td align="center">6</td>
<td align="center">0.002484</td>
</tr>
<tr>
<td align="center">O</td>
<td align="center">8</td>
<td align="center">0.574930</td>
</tr>
<tr>
<td align="center">Na</td>
<td align="center">11</td>
<td align="center">0.015208</td>
</tr>
<tr>
<td align="center">Mg</td>
<td align="center">12</td>
<td align="center">0.001266</td>
</tr>
<tr>
<td align="center">Al</td>
<td align="center">13</td>
<td align="center">0.019953</td>
</tr>
<tr>
<td align="center">Si</td>
<td align="center">14</td>
<td align="center">0.304627</td>
</tr>
<tr>
<td align="center">K</td>
<td align="center">19</td>
<td align="center">0.010045</td>
</tr>
<tr>
<td align="center">Ca</td>
<td align="center">20</td>
<td align="center">0.042951</td>
</tr>
<tr>
<td align="center">Fe</td>
<td align="center">26</td>
<td align="center">0.006435</td>
</tr>
</tbody>
</table>
<p>So we need to combine linearly the mass attenuation coefficients for all these
elements. We first start a new python session, define the chemical composition
and import the table. Then, we interpolate linearly (in log-space) the tables
and compute the linear combination.</p>
<p>Note that I shifted the sampling points slightly to the left and right of each
absorption edges in order to facilitate interpolation.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">os.path</span>

<span class="kn">import</span> <span class="nn">h5py</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span>

<span class="n">input_name</span> <span class="o">=</span> <span class="s1">&#39;X-ray_mass_absorption_coefficients.hdf5&#39;</span>
<span class="n">output_name</span> <span class="o">=</span> <span class="s1">&#39;cement.png&#39;</span>

<span class="n">composition</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;H&#39;</span><span class="p">:</span> <span class="mf">0.022100</span><span class="p">,</span>
               <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="mf">0.002484</span><span class="p">,</span>
               <span class="s1">&#39;O&#39;</span><span class="p">:</span> <span class="mf">0.574930</span><span class="p">,</span>
               <span class="s1">&#39;Na&#39;</span><span class="p">:</span> <span class="mf">0.015208</span><span class="p">,</span>
               <span class="s1">&#39;Mg&#39;</span><span class="p">:</span> <span class="mf">0.001266</span><span class="p">,</span>
               <span class="s1">&#39;Al&#39;</span><span class="p">:</span> <span class="mf">0.019953</span><span class="p">,</span>
               <span class="s1">&#39;Si&#39;</span><span class="p">:</span> <span class="mf">0.304627</span><span class="p">,</span>
               <span class="s1">&#39;K&#39;</span> <span class="p">:</span> <span class="mf">0.010045</span><span class="p">,</span>
               <span class="s1">&#39;Ca&#39;</span><span class="p">:</span> <span class="mf">0.042951</span><span class="p">,</span>
               <span class="s1">&#39;Fe&#39;</span><span class="p">:</span> <span class="mf">0.006435</span><span class="p">}</span>

<span class="n">ref_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.00000E-03</span><span class="p">,</span> <span class="mf">3.466E+03</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">1.03542E-03</span><span class="p">,</span> <span class="mf">3.164E+03</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">1.07209999E-03</span><span class="p">,</span> <span class="mf">2.889E+03</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">1.07210001E-03</span><span class="p">,</span> <span class="mf">2.978E+03</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">1.18283E-03</span><span class="p">,</span> <span class="mf">2.302E+03</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">1.30499999E-03</span><span class="p">,</span> <span class="mf">1.775E+03</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">1.30500001E-03</span><span class="p">,</span> <span class="mf">1.781E+03</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">1.50000E-03</span><span class="p">,</span> <span class="mf">1.227E+03</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">1.55959999E-03</span><span class="p">,</span> <span class="mf">1.104E+03</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">1.55960001E-03</span><span class="p">,</span> <span class="mf">1.176E+03</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">1.69350E-03</span><span class="p">,</span> <span class="mf">9.419E+02</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">1.83889999E-03</span><span class="p">,</span> <span class="mf">7.525E+02</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">1.83890001E-03</span><span class="p">,</span> <span class="mf">1.631E+03</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">2.00000E-03</span><span class="p">,</span> <span class="mf">1.368E+03</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">3.00000E-03</span><span class="p">,</span> <span class="mf">4.646E+02</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">3.60739999E-03</span><span class="p">,</span> <span class="mf">2.804E+02</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">3.60740001E-03</span><span class="p">,</span> <span class="mf">2.911E+02</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">4.00000E-03</span><span class="p">,</span> <span class="mf">2.188E+02</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">4.03809999E-03</span><span class="p">,</span> <span class="mf">2.131E+02</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">4.03810001E-03</span><span class="p">,</span> <span class="mf">2.520E+02</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">5.00000E-03</span><span class="p">,</span> <span class="mf">1.401E+02</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">6.00000E-03</span><span class="p">,</span> <span class="mf">8.401E+01</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">7.11199999E-03</span><span class="p">,</span> <span class="mf">5.187E+01</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">7.11200001E-03</span><span class="p">,</span> <span class="mf">5.415E+01</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">8.00000E-03</span><span class="p">,</span> <span class="mf">3.878E+01</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">1.00000E-02</span><span class="p">,</span> <span class="mf">2.045E+01</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">1.50000E-02</span><span class="p">,</span> <span class="mf">6.351E+00</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">2.00000E-02</span><span class="p">,</span> <span class="mf">2.806E+00</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">3.00000E-02</span><span class="p">,</span> <span class="mf">9.601E-01</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">4.00000E-02</span><span class="p">,</span> <span class="mf">5.058E-01</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">5.00000E-02</span><span class="p">,</span> <span class="mf">3.412E-01</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">6.00000E-02</span><span class="p">,</span> <span class="mf">2.660E-01</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">8.00000E-02</span><span class="p">,</span> <span class="mf">2.014E-01</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">1.00000E-01</span><span class="p">,</span> <span class="mf">1.738E-01</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">1.50000E-01</span><span class="p">,</span> <span class="mf">1.436E-01</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">2.00000E-01</span><span class="p">,</span> <span class="mf">1.282E-01</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">3.00000E-01</span><span class="p">,</span> <span class="mf">1.097E-01</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">4.00000E-01</span><span class="p">,</span> <span class="mf">9.783E-02</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">5.00000E-01</span><span class="p">,</span> <span class="mf">8.915E-02</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">6.00000E-01</span><span class="p">,</span> <span class="mf">8.236E-02</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">8.00000E-01</span><span class="p">,</span> <span class="mf">7.227E-02</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">1.00000E+00</span><span class="p">,</span> <span class="mf">6.495E-02</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">1.25000E+00</span><span class="p">,</span> <span class="mf">5.807E-02</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">1.50000E+00</span><span class="p">,</span> <span class="mf">5.288E-02</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">2.00000E+00</span><span class="p">,</span> <span class="mf">4.557E-02</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">3.00000E+00</span><span class="p">,</span> <span class="mf">3.701E-02</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">4.00000E+00</span><span class="p">,</span> <span class="mf">3.217E-02</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">5.00000E+00</span><span class="p">,</span> <span class="mf">2.908E-02</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">6.00000E+00</span><span class="p">,</span> <span class="mf">2.697E-02</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">8.00000E+00</span><span class="p">,</span> <span class="mf">2.432E-02</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">1.00000E+01</span><span class="p">,</span> <span class="mf">2.278E-02</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">1.50000E+01</span><span class="p">,</span> <span class="mf">2.096E-02</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">2.00000E+01</span><span class="p">,</span> <span class="mf">2.030E-02</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">interp_loglog</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">y</span><span class="p">),</span>
                 <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">assume_sorted</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">t</span><span class="p">)))</span>


<span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">input_name</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">interp_loglog</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">])</span>
          <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">composition</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">ref_data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">y_expected</span> <span class="o">=</span> <span class="n">ref_data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">y_actual</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">y_expected</span><span class="p">)</span>

<span class="n">y_actual</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">composition</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">mu</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">composition</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;../include/zenburn-light.mplstyle&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y_expected</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;NIST&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y_actual</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;This post&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Photon energy [MeV]&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\mu/\rho [\mathrm</span><span class="si">{cm}</span><span class="s1">^2/\mathrm</span><span class="si">{g}</span><span class="s1">]$&#39;</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">output_name</span><span class="p">),</span> <span class="n">transparent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

<p>This produces the following figure, which shows an excellent agreement with the
NIST reference data (which is interpolated much more cleverly).  This validates
our Scrapy procedure!</p>
<p><img alt="Cement" src="https://sbrisard.github.io/posts/20170531-Scrapy-ing_the_NIST_X-ray_Attenuation_Databases/cement.png"></p>
<h2>Closing words</h2>
<p>In this blog, we learned how to use <a href="https://scrapy.org/">Scrapy</a> to retrieve
some tabulated data that is not available as downloaded files.  This is probably
the most basic use of this tool, which is very simple, and a joy to use!</p>
<p>The whole <code>scrapymu</code> project is available on
<a href="https://github.com/sbrisard/scrapymu.git">GitHub</a>.</p>
<!-- Local Variables: -->
<!-- fill-column: 80 -->
<!-- End: -->
  </div><!-- /.entry-content -->
</section>
<section>
  <h2>Comments</h2>
  <p>Please send your comments to <strong><code>sebastien [dot]
  brisard [at] univ [dash] eiffel [dot] fr</code></strong>. Your comments will be
  inserted below. Your email address will <em>not</em> appear.</p>
</section>
    <footer id="contentinfo" class="body">
      <p><a rel="license" href="http://creativecommons.org/licenses/by/4.0/" ><img alt="Creative Commons License" style="float:left;margin-right:5px;" src="https://i.creativecommons.org/l/by/4.0/88x31.png"/></a>Except where otherwise noted, content on this blog by <a href="https://cv.archives-ouvertes.fr/sbrisard">Sébastien Brisard</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>&nbsp;&mdash;&nbsp;This blog is proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>&nbsp;&mdash;&nbsp;This blog uses <a href="https://www.nordtheme.com/">Nord</a>, an arctic north-bluish color palette.</p>
    </footer>
  </body>
</html>